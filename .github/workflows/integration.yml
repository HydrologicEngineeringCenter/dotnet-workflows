name: Integration

on:
  workflow_call:
    inputs:
      dotnet-version:
        type: string
        default: '9.0.x'
        description: '.NET SDK version to use'
      warnings-as-errors:
        type: boolean
        default: false
        description: 'Treat compiler warnings as errors'
      run-tests:
        type: boolean
        default: false
        description: 'Run tests after build'
      project-names:
        type: string
        default: ''
        description: 'Comma-separated list of project names to build/test (if empty, builds entire solution)'

jobs:
  CI:
    runs-on: windows-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET Core SDK ${{ inputs.dotnet-version }}
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ inputs.dotnet-version }}

    - name: Build
      shell: pwsh
      run: |
        $warningsFlag = if ("${{ inputs.warnings-as-errors }}" -eq "true") { "-warnaserror" } else { "" }
        $projectNames = "${{ inputs.project-names }}"
        if ([string]::IsNullOrWhiteSpace($projectNames)) {
          dotnet build -c Release $warningsFlag
        } else {
          $projects = $projectNames -split ',' | ForEach-Object { $_.Trim() }
          foreach ($project in $projects) {
            Write-Host "Building $project"
            dotnet build $project -c Release $warningsFlag
          }
        }

    - name: Test
      if: ${{ inputs.run-tests }}
      run: dotnet test -c Release
