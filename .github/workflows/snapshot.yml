name: Snapshot

on:
  workflow_call:
    inputs:
      dotnet-version:
        type: string
        default: '9.0.x'
        description: '.NET SDK version to use'
      project-names:
        type: string
        required: true
        description: 'Comma-separated list of project names to pack'
      version:
        type: string
        default: '0.0.0'
        description: 'Base version for snapshot packages'
      run-tests:
        type: boolean
        default: false
        description: 'Run tests after build'
      nuget-source:
        type: string
        required: true
        description: 'NuGet repository URL to publish packages to'
    secrets:
      NUGET_API_KEY:
        required: true
        description: 'API key for NuGet repository'

jobs:
  build:
    runs-on: windows-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET Core SDK ${{ inputs.dotnet-version }}
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ inputs.dotnet-version }}

    - name: Build
      shell: pwsh
      run: |
        $projectNames = "${{ inputs.project-names }}" -split ',' | ForEach-Object { $_.Trim() }
        $snapshotVersion = "${{ inputs.version }}.${{ github.run_number }}-dev"
        foreach ($project in $projectNames) {
          Write-Host "Building $project with version: $snapshotVersion"
          dotnet build $project -c Release /p:Version=$snapshotVersion
        }

    - name: Test
      if: ${{ inputs.run-tests }}
      run: dotnet test -c Release

    - name: Pack
      shell: pwsh
      run: |
        $projectNames = "${{ inputs.project-names }}" -split ',' | ForEach-Object { $_.Trim() }
        $snapshotVersion = "${{ inputs.version }}.${{ github.run_number }}-dev"
        foreach ($project in $projectNames) {
          Write-Host "Packing $project with version: $snapshotVersion"
          dotnet pack $project --configuration Release /p:Version=$snapshotVersion --no-build -o ./packages
        }

    - name: Publish
      run: dotnet nuget push "**/*.nupkg" --api-key ${{ secrets.NUGET_API_KEY }} --source "${{ inputs.nuget-source }}" --skip-duplicate
